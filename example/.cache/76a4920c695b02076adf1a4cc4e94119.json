{"dependencies":[{"name":"babel-runtime/core-js/promise"},{"name":"babel-runtime/regenerator"},{"name":"babel-runtime/helpers/asyncToGenerator"},{"name":"babel-runtime/core-js/object/get-prototype-of"},{"name":"babel-runtime/helpers/possibleConstructorReturn"},{"name":"babel-runtime/helpers/inherits"},{"name":"babel-runtime/helpers/classCallCheck"},{"name":"babel-runtime/helpers/createClass"},{"name":"./queue.js"}],"generated":{"js":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.TextGroupItem = exports.TextItem = exports.ImageItem = undefined;\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _queue = require(\"./queue.js\");\n\nvar _queue2 = _interopRequireDefault(_queue);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar Item = function () {\n  function Item(ctx, data) {\n    (0, _classCallCheck3.default)(this, Item);\n\n    this.ctx = ctx;\n    this.width = data.width;\n    this.height = data.height;\n    this.x = data.left || 0;\n    this.y = data.top || 0;\n    this.value = data.value || '';\n    this.opacity = data.opacity || 1;\n    this.rotate = data.rotate || 0;\n    this.centerX = this.x + this.width / 2;\n    this.centerY = this.y + this.height / 2;\n  }\n\n  (0, _createClass3.default)(Item, [{\n    key: \"rotateCanvas\",\n    value: function rotateCanvas(ctx) {\n      ctx.translate(this.centerX, this.centerY);\n      ctx.rotate(this.rotate * Math.PI / 180);\n    }\n  }, {\n    key: \"add\",\n    value: function add() {\n      var _this = this;\n\n      _queue2.default.push(function () {\n        return _this.draw();\n      });\n    }\n  }, {\n    key: \"draw\",\n    value: function draw() {\n      _queue2.default.next();\n    }\n  }]);\n  return Item;\n}();\n\nvar ImageItem = function (_Item) {\n  (0, _inherits3.default)(ImageItem, _Item);\n\n  function ImageItem(ctx, data) {\n    (0, _classCallCheck3.default)(this, ImageItem);\n    return (0, _possibleConstructorReturn3.default)(this, (ImageItem.__proto__ || (0, _getPrototypeOf2.default)(ImageItem)).call(this, ctx, data));\n  }\n\n  (0, _createClass3.default)(ImageItem, [{\n    key: \"draw\",\n    value: function () {\n      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n        var ctx;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                ctx = this.ctx;\n\n                ctx.save();\n                ctx.globalAlpha = this.opacity;\n                this.rotateCanvas(ctx);\n                _context.next = 6;\n                return this.imagePromise(this.value);\n\n              case 6:\n                this.image = _context.sent;\n\n                ctx.drawImage(this.image, -this.width / 2, -this.height / 2, this.width, this.height);\n                ctx.restore();\n                _queue2.default.next();\n\n              case 10:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function draw() {\n        return _ref.apply(this, arguments);\n      }\n\n      return draw;\n    }()\n  }, {\n    key: \"imagePromise\",\n    value: function imagePromise(value) {\n      var image = new Image();\n      image.src = value;\n      return new _promise2.default(function (resolve) {\n        image.onload = function () {\n          resolve(image);\n        };\n      });\n    }\n  }]);\n  return ImageItem;\n}(Item);\n\nvar TextItem = function (_Item2) {\n  (0, _inherits3.default)(TextItem, _Item2);\n\n  function TextItem(ctx, data) {\n    (0, _classCallCheck3.default)(this, TextItem);\n\n    var _this3 = (0, _possibleConstructorReturn3.default)(this, (TextItem.__proto__ || (0, _getPrototypeOf2.default)(TextItem)).call(this, ctx, data));\n\n    var style = data.style;\n    _this3.fontSize = style['font-size'] || 28;\n    _this3.fontFamily = style['font-family'] || 'sans-serif';\n    _this3.textAlgin = style['text-align'] || 'left';\n    _this3.letterSpacing = style['letter-spacing'] || 2;\n    _this3.lineHeight = style['line-height'] || _this3.fontSize + 4;\n    _this3.color = style.color || '#1a1a1a';\n    return _this3;\n  }\n\n  (0, _createClass3.default)(TextItem, [{\n    key: \"draw\",\n    value: function draw() {\n      this.pureDraw();\n      _queue2.default.next();\n    }\n  }, {\n    key: \"pureDraw\",\n    value: function pureDraw() {\n      var ctx = this.ctx;\n      ctx.save();\n      this.setFont(ctx);\n      this.rotateCanvas(ctx);\n      // for debug\n      // ctx.rect(this.x - this.centerX, this.y - this.centerY, this.width, this.height)\n      // ctx.stroke()\n      // for debug\n\n      this.drawOneLineText(ctx);\n      ctx.restore();\n    }\n  }, {\n    key: \"setFont\",\n    value: function setFont(ctx) {\n      ctx.textBaseline = 'top';\n      ctx.font = this.fontSize + \"px \" + this.fontFamily;\n      ctx.fillStyle = this.color;\n    }\n    // 增加自动换行，行高， letter-spacing， 文字对齐文字绘制\n    // TODO\n\n  }, {\n    key: \"drawText\",\n    value: function drawText(ctx) {\n      var originRowLength = ctx.measureText(this.value).width;\n      var startX = this.letterSpacing;\n      //\n      var dy = (this.lineHeight - this.fontSize) / 2;\n      // let \n      for (var i = 0, len = this.value.length; i < len; i++) {\n\n        if (x + letterWidth / len > this.width) {\n          var row = (x + letterWidth / len) / this.width;\n          // x = x - this.width * row - this.letterSpacing\n          y = this.y + row * this.lineHeight + dy;\n        }\n        ctx.fillText(this.value[i], x - centerX, y - centerY);\n      }\n    }\n    // 绘制开始位置，字宽\n\n  }, {\n    key: \"getLetterInfo\",\n    value: function getLetterInfo(ctx) {\n      var originRowLength = ctx.measureText(this.value).width;\n      var textLen = this.value.length;\n      var letterWidth = originRowLength / textLen;\n      var startX = 0;\n      if (this.textAlgin === 'left') {\n        startX = 0;\n      } else if (this.textAlgin === 'center') {\n\n        startX = (this.width - (originRowLength + (textLen - 1) * this.letterSpacing)) / 2;\n      } else {\n        startX = this.width - (originRowLength + (textLen + 1) * this.letterSpacing);\n      }\n\n      startX < 0 ? startX = 0 : null;\n      return { startX: startX, letterWidth: letterWidth };\n    }\n    // 提供行高，letter-spacing, 文字对齐\n\n  }, {\n    key: \"drawOneLineText\",\n    value: function drawOneLineText(ctx) {\n      var _getLetterInfo = this.getLetterInfo(ctx),\n          startX = _getLetterInfo.startX,\n          letterWidth = _getLetterInfo.letterWidth;\n\n      var dy = (this.lineHeight - this.fontSize) / 2;\n      for (var i = 0, len = this.value.length; i < len; i++) {\n        var _x = this.x + startX + letterWidth * i + this.letterSpacing * i;\n        // if (x + letterWidth > this.width) return\n        ctx.fillText(this.value[i], _x - this.centerX, this.y + dy - this.centerY);\n      }\n    }\n  }]);\n  return TextItem;\n}(Item);\n\nvar TextGroupItem = function (_Item3) {\n  (0, _inherits3.default)(TextGroupItem, _Item3);\n\n  function TextGroupItem(ctx, data) {\n    (0, _classCallCheck3.default)(this, TextGroupItem);\n\n    var _this4 = (0, _possibleConstructorReturn3.default)(this, (TextGroupItem.__proto__ || (0, _getPrototypeOf2.default)(TextGroupItem)).call(this, ctx, data));\n\n    _this4.data = data;\n    _this4.items = data.items;\n    _this4.canvas = document.createElement('canvas');\n    _this4.canvas.width = _this4.width;\n    _this4.canvas.height = _this4.height;\n    _this4.parentCtx = ctx;\n    _this4.ctx = _this4.canvas.getContext('2d');\n\n    return _this4;\n  }\n\n  (0, _createClass3.default)(TextGroupItem, [{\n    key: \"draw\",\n    value: function draw() {\n      var ctx = this.ctx;\n      var parentCtx = this.parentCtx;\n      this.drawTexts(ctx);\n      parentCtx.save();\n      this.rotateCanvas(parentCtx);\n      // 绘制子元素\n      parentCtx.drawImage(this.canvas, this.x - this.centerX, this.y - this.centerY, this.width, this.height);\n      parentCtx.restore();\n      _queue2.default.next();\n    }\n  }, {\n    key: \"drawTexts\",\n    value: function drawTexts(ctx) {\n      this.items.forEach(function (item) {\n        var tmpItem = new TextItem(ctx, item);\n        tmpItem.pureDraw();\n      });\n    }\n  }]);\n  return TextGroupItem;\n}(Item);\n\nexports.ImageItem = ImageItem;\nexports.TextItem = TextItem;\nexports.TextGroupItem = TextGroupItem;"},"hash":"3ebeba4acc4e90a8d29225ba6bdd4ee8"}